<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî Telegram Order Automation (EVOS-style, Kafolat Red)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f4f5f7;
      --card:#fff;
      --muted:#6b7280;
      --accent:#111827;
      --brand:#d32f2f; /* primary brand red */
      --radius:14px;
      --soft:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:16px 16px 110px; /* –æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –¥–ª—è –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .topbar{
      background:linear-gradient(90deg, rgba(211,47,47,0.08), rgba(211,47,47,0.03));
      border-radius:18px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      box-shadow:0 6px 18px rgba(12,15,20,0.03);
      margin-bottom:12px;
    }
    .logo-img{width:110px; height:auto; object-fit:contain}
    .search-box{flex:1; display:flex; gap:8px; align-items:center}
    .search{width:100%; background:#fff; border-radius:999px; padding:10px 14px; border:1px solid #eee; font-size:15px}
    .address{font-size:12px; color:var(--muted)}

    /* chips - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .chips {
      display:flex;
      gap:10px;
      overflow:auto;
      padding:10px 4px;
      margin-bottom:8px;
      align-items:center;
    }

    .chip {
      min-width:84px;
      flex:0 0 auto;
      background:#fff;
      border-radius:12px;
      padding:10px;
      text-align:center;
      box-shadow:0 6px 18px rgba(12,15,20,0.03);
      cursor:pointer;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;

      /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∞—è –ø—Ä—ã–∂–∫–∏ */
      min-height:64px;
      height:64px;

      /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Ñ–æ–Ω–∞ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
      transition: background-color .18s ease, transform .18s ease, color .18s ease;
      will-change: background-color, transform;
    }

    .chip img {
      height:36px;
      width:36px;
      object-fit:contain;
      display:block;
      margin-bottom:6px;
      flex:0 0 auto;
    }

    .chip .chip-label {
      font-weight:600;
      font-size:13px;
      line-height:1;
      white-space:nowrap;
      color:inherit;
    }

    .chip.active {
      background:var(--brand);
      color:#fff;
      transform:translateY(-4px);
    }

    .chip.active .chip-label {
      color:#fff;
      /* –Ω–µ –º–µ–Ω—è–µ–º font-weight —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ */
    }

    /* banner */
    .banner{display:flex; gap:12px; align-items:center; padding:14px; border-radius:14px; background:linear-gradient(90deg,var(--brand),#ff7b7b); color:#fff; margin-bottom:14px}
    .banner img{height:84px; border-radius:10px}
    .banner h2{margin:0;font-size:18px}
    .banner p{margin:4px 0 0; opacity:0.95}

    /* controls row: filters, sort */
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .filters{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .filter-chip{padding:6px 10px; background:#fff; border:1px solid #e6e7eb; border-radius:999px; font-size:13px; cursor:pointer}
    .filter-chip.active{background:var(--brand); color:#fff;}

    .sort{padding:8px; border-radius:10px; border:1px solid #e6e7eb; background:#fff}

    /* grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:0 6px 18px rgba(12,15,20,0.04);
      display:flex;
      flex-direction:column;
      gap:10px;
      cursor:default;
    }
    .thumb{
      width:100%;
      height:140px;
      border-radius:12px;
      object-fit:cover;
      background:#f0f0f0;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:13px;
      overflow:hidden;
      position:relative;
    }
    .title{font-weight:700; font-size:14px}
    .desc{font-size:12px; color:var(--muted); min-height:36px}
    .price-row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .price{font-weight:800; color:var(--brand)}
    .controls-row{display:flex; justify-content:space-between; align-items:center; gap:8px}

    /* qty */
    .qty-box{display:flex; align-items:center; gap:8px}
    .qty-btn{
      width:36px; height:36px; border-radius:10px; border:none; background:#f2f3f5; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; font-size:18px;
    }
    .qty-value{min-width:28px; text-align:center; font-weight:700;}

    .btn-primary{
      background:var(--brand);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
    }

    /* bottom nav */
    .bottom-nav{
      position:fixed; left:12px; right:12px; bottom:12px; height:64px; background:#fff; border-radius:20px; display:flex; justify-content:space-around; align-items:center; box-shadow:0 10px 30px rgba(0,0,0,0.08);
      padding:8px 18px; gap:12px; z-index:80
    }
    .nav-item{display:flex; flex-direction:column; align-items:center; gap:6px; font-size:12px; color:var(--muted); cursor:pointer}
    .nav-item.active{color:var(--brand)}

    .cart-float{position:fixed; right:28px; bottom:92px; background:var(--brand); color:#fff; padding:10px 14px; border-radius:999px; box-shadow:0 10px 30px rgba(0,0,0,0.2); font-weight:700; z-index:90; display:none}

    /* modals */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:200;
    }
    .modal{width:95%; max-width:840px; background:#fff; border-radius:14px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,0.2); max-height:90vh; overflow:auto}

    /* helpers */
    .empty{padding:24px; text-align:center; color:var(--muted); border-radius:10px; background:#fff}
    @media (max-width:520px){
      .thumb{height:120px}
      .banner img{height:68px}
      body{padding-bottom:140px}
      .logo-img{width:96px}
    }
  </style>
</head>
<body>

  <!-- topbar -->
  <div class="topbar">
    <img src="images/logo.png" alt="Kafolat logo" class="logo-img" />
    <div style="flex:1">
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="search-box">
          <input id="searchInput" class="search" placeholder="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º..." />
        </div>
        <button id="openCartQuick" class="btn-primary" title="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">–ö–æ—Ä–∑–∏–Ω–∞</button>
      </div>
      <div style="display:flex; gap:12px; align-items:center; margin-top:8px">
        <div class="address">Telegram Order Automation ‚Äî kafolatplast.uz</div>
        <div style="flex:1"></div>
        <!-- Sort select -->
        <select id="sortSelect" class="sort" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
          <option value="default">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
          <option value="price_asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
          <option value="price_desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
          <option value="name_asc">–ù–∞–∑–≤–∞–Ω–∏–µ: A‚ÜíZ</option>
          <option value="name_desc">–ù–∞–∑–≤–∞–Ω–∏–µ: Z‚ÜíA</option>
        </select>
      </div>
    </div>
  </div>

  <!-- categories (chips) -->
  <div class="chips" id="categoryTabs"></div>

  <!-- banner -->
  <div class="banner">
    <div style="flex:1">
      <h2>–ù–æ–≤–∞—è –ª–∏–Ω–µ–π–∫–∞ Kafolat ‚Äî —Å–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞</h2>
      <p>–ê–∫—Ü–∏—è: –ø–µ—Ä–≤—ã–µ 100 –∑–∞–∫–∞–∑–æ–≤ ‚Äî —Å–∫–∏–¥–∫–∞. –£–¥–æ–±–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥, –ø—Ä–æ—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞.</p>
    </div>
    <img src="images/banner-product.png" alt="banner" />
  </div>

  <!-- controls (filters) -->
  <div class="controls">
    <div class="filters" id="extraFilters">
      <button id="filterSale" class="filter-chip">–¢–æ–ª—å–∫–æ –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ</button>
      <label style="display:flex;gap:6px;align-items:center;font-size:13px">
        –¶–µ–Ω–∞:
        <input id="priceMin" type="number" placeholder="–æ—Ç" style="width:80px;padding:6px;border-radius:8px;border:1px solid #eee;margin-left:6px">
        <input id="priceMax" type="number" placeholder="–¥–æ" style="width:80px;padding:6px;border-radius:8px;border:1px solid #eee;margin-left:6px">
      </label>
      <button id="applyFilters" class="filter-chip">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button id="clearFilters" class="filter-chip">–°–±—Ä–æ—Å</button>
    </div>
    <div style="flex:1"></div>
    <div style="font-size:13px;color:var(--muted)">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É ‚Äî –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>
  </div>

  <!-- grid -->
  <div id="grid" class="grid"></div>
  <div id="empty" style="display:none" class="empty">–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>

  <!-- floating cart info -->
  <div id="cartFloat" class="cart-float">–ö–æ—Ä–∑–∏–Ω–∞: <span id="cartCount">0</span> ‚Ä¢ <span id="cartTotal">0 so'm</span></div>

  <!-- product modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div>
          <div id="modalTitle" style="font-weight:800; font-size:18px"></div>
          <div id="modalPrice" style="color:var(--brand); font-weight:800; margin-top:6px"></div>
        </div>
        <div>
          <button id="closeModal" class="qty-btn">‚úï</button>
        </div>
      </div>

      <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
        <img id="modalBig" class="big-img" src="" alt="image" style="width:320px;height:260px;object-fit:cover;border-radius:12px;background:#f6f6f6" />

        <div style="flex:1; min-width:220px;">
          <div id="modalDesc" class="specs" style="color:var(--muted)"></div>

          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <div class="qty-box">
              <button id="modalMinus" class="qty-btn">‚àí</button>
              <div id="modalQty" class="qty-value">0</div>
              <button id="modalPlus" class="qty-btn">+</button>
            </div>
            <button id="modalAdd" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>

          <div id="modalGallery" class="gallery" style="margin-top:12px;display:flex;gap:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- cart modal (–ø–æ–ª–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞) -->
  <div id="cartBackdrop" class="modal-backdrop">
    <div class="modal" style="max-width:760px">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:700">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div><button id="closeCart" class="qty-btn">‚úï</button></div>
      </div>

      <div id="cartItems" style="margin-top:10px"></div>

      <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:700" id="cartSummaryText">–ò—Ç–æ–≥–æ: 0 so'm</div>
        <div style="display:flex; gap:8px;">
          <button id="cartCancel" class="btn-primary" style="background:#fff;color:var(--accent);border:1px solid #e6e7eb">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
          <button id="clearCartBtn" class="btn-primary" style="background:#f3f4f6;color:var(--accent);border:1px solid #e6e7eb">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="cartSend" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" data-nav="menu"> <div>üè†</div> <div>–ú–µ–Ω—é</div></div>
    <div class="nav-item" data-nav="shops"> <div>üìç</div> <div>–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</div></div>
    <div class="nav-item" data-nav="cart"> <div>üõí</div> <div>–°–∞–≤–∞—Ç</div></div>
    <div class="nav-item" data-nav="profile"> <div>üë§</div> <div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
    <div style="flex:0 0 120px; display:flex; align-items:center; justify-content:center;">
      <button id="checkoutBtn" class="btn-primary" style="padding:8px 12px">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </div>

  <!-- Telegram WebApp script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
let categories = [];
let categoryNames = {};
let items = [];

async function loadProducts() {
  try {
    const response = await fetch("https://www.api.kafolatplast.uz/api/products");

 items = await response.json();

// === —Å—Ç—Ä–æ–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ API ===
categories = [...new Set(items.map(i => i.category))];
categories.forEach(c => {
  categoryNames[c] = c;
});

// üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û
state.category = categories.length ? categories[0] : null;

// —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
renderCategoryChips();
loadFilterInputs();
renderGrid();
renderCartList();


    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:", error);
    document.getElementById("empty").style.display = "block";
  }
}

// –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ WebApp
loadProducts();


    const placeholder = "data:image/svg+xml;utf8," + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#f0f0f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="#9ca3af">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</text></svg>'
    );

    /*************** —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ storage *****************/
    const STORAGE_KEY = "tg_shop_v3_kafolat";
    let state = { cart:{}, category: null, search:"", sort:"default", filters: { saleOnly:false, priceMin:null, priceMax:null } };
    try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn(e); }

    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function formatPrice(n){ return n.toLocaleString('ru-RU') + " so'm"; }
    function calcCart(){ let total=0,count=0; for(const idStr in state.cart){ const id = Number(idStr); const qty = state.cart[idStr]; const it = items.find(x=>x.id===id); if(it){ total += it.price * qty; count += qty; } } return { total, count }; }

    /**************** refs *****************/
    const categoryTabs = document.getElementById('categoryTabs');
    const grid = document.getElementById('grid');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const cartFloat = document.getElementById('cartFloat');
    const cartCountEl = document.getElementById('cartCount');
    const cartTotalEl = document.getElementById('cartTotal');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const modalBig = document.getElementById('modalBig');
    const modalQty = document.getElementById('modalQty');
    const modalMinus = document.getElementById('modalMinus');
    const modalPlus = document.getElementById('modalPlus');
    const modalAdd = document.getElementById('modalAdd');
    const modalGallery = document.getElementById('modalGallery');
    const closeModalBtn = document.getElementById('closeModal');

    const cartBackdrop = document.getElementById('cartBackdrop');
    const cartItemsEl = document.getElementById('cartItems');
    const closeCart = document.getElementById('closeCart');
    const cartCancel = document.getElementById('cartCancel');
    const cartSend = document.getElementById('cartSend');
    const cartSummaryText = document.getElementById('cartSummaryText');
    const clearCartBtn = document.getElementById('clearCartBtn');

    const filterSaleBtn = document.getElementById('filterSale');
    const priceMinEl = document.getElementById('priceMin');
    const priceMaxEl = document.getElementById('priceMax');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const clearFiltersBtn = document.getElementById('clearFilters');

    const openCartQuick = document.getElementById('openCartQuick');
    const checkoutBtn = document.getElementById('checkoutBtn');

    /**************** UI: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ****************/
    function renderCategoryChips(){
      categoryTabs.innerHTML = '';
      categories.forEach(cat=>{
        const el = document.createElement('div');
        el.className = 'chip' + (state.category === cat ? ' active' : '');
        // –∏—Å–ø–æ–ª—å–∑—É–µ–º chip-label –≤–Ω—É—Ç—Ä–∏
        el.innerHTML = `<img src="images/chip-${cat}.png" alt="${cat}" onerror="this.style.display='none'"><div class="chip-label">${categoryNames[cat]}</div>`;
        el.addEventListener('click', ()=>{ state.category = cat; saveState(); renderCategoryChips(); renderGrid(); });
        categoryTabs.appendChild(el);
      });
    }

    /**************** —Ñ–∏–ª—å—Ç—Ä—ã ****************/
    function loadFilterInputs(){
      filterSaleBtn.classList.toggle('active', !!state.filters.saleOnly);
      priceMinEl.value = state.filters.priceMin || '';
      priceMaxEl.value = state.filters.priceMax || '';
    }

    filterSaleBtn.addEventListener('click', ()=>{
      state.filters.saleOnly = !state.filters.saleOnly;
      filterSaleBtn.classList.toggle('active', state.filters.saleOnly);
      saveState(); renderGrid();
    });

    applyFiltersBtn.addEventListener('click', ()=>{
      const min = Number(priceMinEl.value) || null;
      const max = Number(priceMaxEl.value) || null;
      state.filters.priceMin = min;
      state.filters.priceMax = max;
      saveState();
      renderGrid();
    });

    clearFiltersBtn.addEventListener('click', ()=>{
      state.filters = { saleOnly:false, priceMin:null, priceMax:null };
      loadFilterInputs();
      saveState();
      renderGrid();
    });

    /**************** grid rendering ****************/
    function renderGrid(){
      grid.innerHTML = '';
      let list = items.filter(i => i.category === state.category);

      // search
      const q = (state.search || '').trim().toLowerCase();
      if(q) list = list.filter(i => i.name.toLowerCase().includes(q) || (i.desc || '').toLowerCase().includes(q));

      // filters
      if(state.filters.saleOnly) list = list.filter(i => i.sale);
      if(state.filters.priceMin) list = list.filter(i => i.price >= state.filters.priceMin);
      if(state.filters.priceMax) list = list.filter(i => i.price <= state.filters.priceMax);

      // sorting
      if(state.sort === 'price_asc') list.sort((a,b)=>a.price-b.price);
      else if(state.sort === 'price_desc') list.sort((a,b)=>b.price-a.price);
      else if(state.sort === 'name_asc') list.sort((a,b)=>a.name.localeCompare(b.name));
      else if(state.sort === 'name_desc') list.sort((a,b)=>b.name.localeCompare(a.name));

      if(list.length === 0){
        document.getElementById('empty').style.display = 'block';
        return;
      } else {
        document.getElementById('empty').style.display = 'none';
      }

      list.forEach(it=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.addEventListener('click', (e)=>{ if(e.target.closest('.qty-btn') || e.target.closest('.btn-primary')) return; openProductModal(it.id); });

        const thumb = document.createElement('div'); thumb.className='thumb';
        const img = document.createElement('img'); img.src = (it.images && it.images.length)? it.images[0] : placeholder; img.alt = it.name;
        img.onerror = function(){ this.src = placeholder; };
        thumb.appendChild(img);

        if(it.sale){
          const saleTag = document.createElement('div');
          saleTag.style.position='absolute'; saleTag.style.left='12px'; saleTag.style.top='12px';
          saleTag.style.background = 'var(--brand)'; saleTag.style.color='#fff'; saleTag.style.padding='6px 8px'; saleTag.style.borderRadius='999px';
          saleTag.style.fontWeight='700'; saleTag.style.fontSize='12px'; saleTag.textContent = '–ê–ö–¶–ò–Ø';
          thumb.appendChild(saleTag);
        }

        const title = document.createElement('div'); title.className='title'; title.textContent = it.name;
        const desc = document.createElement('div'); desc.className='desc'; desc.textContent = it.desc;
        const priceRow = document.createElement('div'); priceRow.className='price-row';
        const price = document.createElement('div'); price.className='price'; price.textContent = formatPrice(it.price);
        priceRow.appendChild(price);

        const controlsRow = document.createElement('div'); controlsRow.className='controls-row';
        const qtyBox = document.createElement('div'); qtyBox.className='qty-box';
        const minus = document.createElement('button'); minus.className='qty-btn'; minus.textContent='‚àí';
        const qval = document.createElement('div'); qval.className='qty-value'; qval.textContent = state.cart[it.id] || 0;
        const plus = document.createElement('button'); plus.className='qty-btn'; plus.textContent='+';
        minus.addEventListener('click', (ev)=>{ ev.stopPropagation(); changeQty(it.id, -1); qval.textContent = state.cart[it.id] || 0; renderCartList(); });
        plus.addEventListener('click', (ev)=>{ ev.stopPropagation(); changeQty(it.id, 1); qval.textContent = state.cart[it.id] || 0; renderCartList(); });
        qtyBox.appendChild(minus); qtyBox.appendChild(qval); qtyBox.appendChild(plus);

        const addBtn = document.createElement('button'); addBtn.className='btn-primary'; addBtn.textContent='–í –∫–æ—Ä–∑–∏–Ω—É';
        addBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); changeQty(it.id, 1); qval.textContent = state.cart[it.id] || 0; renderCartList(); });

        controlsRow.appendChild(qtyBox); controlsRow.appendChild(addBtn);

        card.appendChild(thumb); card.appendChild(title); card.appendChild(desc); card.appendChild(priceRow); card.appendChild(controlsRow);
        grid.appendChild(card);
      });

      refreshCartUI();
    }

    /**************** cart functionality ****************/
    function changeQty(id, delta){
      const cur = state.cart[id] || 0;
      const next = Math.max(0, cur + delta);
      if(next === 0) delete state.cart[id]; else state.cart[id] = next;
      saveState();
      renderGrid();
      renderCartList();
    }

    function refreshCartUI(){
      const { total, count } = calcCart();
      cartCountEl.textContent = count;
      cartTotalEl.textContent = total.toLocaleString('ru-RU') + " so'm";
      cartFloat.style.display = count > 0 ? 'inline-block' : 'none';
      checkoutBtn.disabled = count === 0;
    }

    /* render cart modal list */
    function renderCartList(){
      cartItemsEl.innerHTML = '';
      const ids = Object.keys(state.cart).map(x=>Number(x));
      if(ids.length === 0){
        cartItemsEl.innerHTML = "<div class='empty'>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>";
        cartSummaryText.textContent = "–ò—Ç–æ–≥–æ: 0 so'm";
        refreshCartUI();
        return;
      }

      ids.forEach(id=>{
        const it = items.find(x=>x.id === id);
        const qty = state.cart[id];
        const row = document.createElement('div');
        row.style.display="flex"; row.style.alignItems="center"; row.style.justifyContent="space-between"; row.style.gap="8px";
        row.style.padding="8px 0"; row.style.borderBottom="1px dashed #eee";

        const left = document.createElement('div'); left.style.display="flex"; left.style.gap="8px"; left.style.alignItems="center";
        const img = document.createElement('img'); img.src = (it.images && it.images.length) ? it.images[0] : placeholder;
        img.style.width="68px"; img.style.height="48px"; img.style.objectFit="cover"; img.style.borderRadius="8px";
        const info = document.createElement('div');
        const name = document.createElement('div'); name.textContent = it.name; name.style.fontWeight="600"; name.style.fontSize="13px";
        const pr = document.createElement('div'); pr.textContent = formatPrice(it.price) + " √ó " + qty; pr.style.color="var(--muted)"; pr.style.fontSize="12px";
        info.appendChild(name); info.appendChild(pr);
        left.appendChild(img); left.appendChild(info);

        const right = document.createElement('div'); right.style.display="flex"; right.style.flexDirection="column"; right.style.alignItems="flex-end";
        const qtyBox = document.createElement('div'); qtyBox.className="qty-box";
        const minus = document.createElement('button'); minus.className='qty-btn'; minus.textContent='‚àí';
        const val = document.createElement('div'); val.className='qty-value'; val.textContent = qty;
        const plus = document.createElement('button'); plus.className='qty-btn'; plus.textContent='+';
        minus.onclick = ()=>{ changeQty(id, -1); renderCartList(); };
        plus.onclick = ()=>{ changeQty(id, 1); renderCartList(); };
        qtyBox.appendChild(minus); qtyBox.appendChild(val); qtyBox.appendChild(plus);

        const sub = document.createElement('div'); sub.textContent = formatPrice(it.price * qty); sub.style.fontWeight="700"; sub.style.marginTop="8px";
        right.appendChild(qtyBox); right.appendChild(sub);

        row.appendChild(left); row.appendChild(right);
        cartItemsEl.appendChild(row);
      });

      const { total } = calcCart();
      cartSummaryText.textContent = "–ò—Ç–æ–≥–æ: " + total.toLocaleString('ru-RU') + " so'm";
      refreshCartUI();
    }

    /**************** product modal ****************/
    let currentModalProduct = null;
    function openProductModal(id){
      const it = items.find(x=>x.id===id); if(!it) return;
      currentModalProduct = it;
      modalTitle.textContent = it.name;
      modalDesc.textContent = it.desc;
      modalBig.src = (it.images && it.images.length)? it.images[0] : placeholder;
      modalQty.textContent = state.cart[it.id] || 0;

      // gallery
      modalGallery.innerHTML = '';
      const imgs = (it.images && it.images.length) ? it.images : [placeholder];
      imgs.forEach(src => { const im = document.createElement('img'); im.src = src; im.style.height='80px'; im.style.width='80px'; im.style.objectFit='cover'; im.style.borderRadius='8px'; im.style.cursor='pointer'; im.onerror = ()=> im.src = placeholder; im.onclick = ()=> modalBig.src = src; modalGallery.appendChild(im); });

      modalBackdrop.style.display = 'flex';
    }

    closeModalBtn.addEventListener('click', ()=>{ modalBackdrop.style.display = 'none'; });
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) modalBackdrop.style.display = 'none'; });
    modalPlus.addEventListener('click', ()=>{ if(!currentModalProduct) return; changeQty(currentModalProduct.id, 1); modalQty.textContent = state.cart[currentModalProduct.id] || 0; });
    modalMinus.addEventListener('click', ()=>{ if(!currentModalProduct) return; changeQty(currentModalProduct.id, -1); modalQty.textContent = state.cart[currentModalProduct.id] || 0; });
    modalAdd.addEventListener('click', ()=>{ if(!currentModalProduct) return; changeQty(currentModalProduct.id, 1); modalQty.textContent = state.cart[currentModalProduct.id] || 0; });

    /**************** cart modal events ****************/
    openCartQuick.addEventListener('click', ()=>{
      renderCartList();
      cartBackdrop.style.display = 'flex';
    });
    closeCart.addEventListener('click', ()=>{ cartBackdrop.style.display = 'none'; });
    cartBackdrop.addEventListener('click', (e)=>{ if(e.target === cartBackdrop) cartBackdrop.style.display = 'none'; });
    cartCancel.addEventListener('click', ()=>{ cartBackdrop.style.display = 'none'; });

    clearCartBtn.addEventListener('click', ()=>{
      if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) return;
      state.cart = {}; saveState(); renderGrid(); renderCartList();
    });

    checkoutBtn.addEventListener('click', ()=>{ openCartQuick.click(); });

    /**************** search & sort ****************/
    function debounce(fn, t){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), t); }; }
    searchInput.addEventListener('input', debounce((e)=>{ state.search = e.target.value; saveState(); renderGrid(); }, 250));
    sortSelect.value = state.sort || 'default';
    sortSelect.addEventListener('change', ()=>{ state.sort = sortSelect.value; saveState(); renderGrid(); });

    /**************** Telegram WebApp helpers & sendOrder ****************/
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    try{ if(tg && typeof tg.ready === 'function') tg.ready(); } catch(e){ console.warn('tg.ready failed', e); }

    let _sendingOrder = false;

    function _buildPayload(){
      const chosen = items.map(i => ({ id: i.id, name: i.name, price: i.price, qty: state.cart[i.id] || 0, category: i.category }))
                         .filter(x => x.qty > 0);
      const { total } = calcCart();
      return {
        items: chosen,
        total,
        createdAt: new Date().toISOString(),
        source: "webapp",
        webappVersion: "v3"
      };
    }

    function sendOrder(){
      if(_sendingOrder){
        console.warn("Order already sending");
        return;
      }

      const payload = _buildPayload();

      // –≤–∞–ª–∏–¥–∞—Ü–∏—è
      if(!Array.isArray(payload.items) || payload.items.length === 0){
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
        return;
      }
      if(!payload.total || payload.total <= 0){
        alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞');
        return;
      }

      console.info('[WebApp] payload to send:', payload);

      // –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      _sendingOrder = true;
      cartSend.disabled = true;
      const oldText = cartSend.textContent;
      cartSend.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...";

      try {
        if (tg && typeof tg.sendData === "function") {
          tg.sendData(JSON.stringify(payload));
          console.info('[WebApp] tg.sendData called.');

          // –î–∞–µ–º Telegram –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É, –∑–∞—Ç–µ–º –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ–±–∞–ø
          setTimeout(()=>{
            try{ if(tg.close) tg.close(); } catch(e){ console.warn('tg.close failed', e); }
          }, 700);

          // –≤–∏–∑—É–∞–ª—å–Ω–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
          cartSend.textContent = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
        } else {
          // fallback: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ json (–¥–ª—è —Ç–µ—Å—Ç–∞ –≤–Ω–µ Telegram)
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'order.json'; document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          alert('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ (order.json). –û—Ç–∫—Ä–æ–π—Ç–µ WebApp –≤ Telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç—É.');
          console.warn('[WebApp] tg.sendData not available (not in Telegram).');
          // —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
          _sendingOrder = false;
          cartSend.disabled = false;
          cartSend.textContent = oldText;
        }
      } catch (err) {
        console.error('[WebApp] sendData error:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        _sendingOrder = false;
        cartSend.disabled = false;
        cartSend.textContent = oldText;
      }
    }

    // –ø–æ–≤–µ—Å–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É (–≤–¥–æ–±–∞–≤–æ–∫ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É)
    cartSend.addEventListener('click', sendOrder);

  /**************** init ****************/
function restoreUI(){
  renderCategoryChips();
  loadFilterInputs();
  renderGrid();
  renderCartList();

  // safety: –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
  const { count } = calcCart();
  cartSend.disabled = count === 0;
}

// ‚ùå –ù–ï –≤—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
// restoreUI();

// ‚úÖ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ API
loadProducts();

window.addEventListener('beforeunload', saveState);
window.addEventListener('pagehide', saveState);

  </script>
</body>
</html>





